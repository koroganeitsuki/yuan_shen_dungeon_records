<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幽境危战 - 管理员后台</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 引入角色和Boss数据 -->
    <script src="data.js"></script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        abyss: {
                            primary: '#7B68EE',
                            secondary: '#9370DB',
                            dark: '#1A1A2E',
                            light: '#E0B0FF',
                            success: '#4CAF50',
                            warning: '#FFC107',
                            danger: '#F44336'
                        },
                    },
                    fontFamily: {
                        genshin: ['"Kaisei Tokumin"', 'serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                    },
                },
            }
        }
    </script>
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bg-gradient-abyss {
                background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            }
            .card-shadow {
                box-shadow: 0 10px 25px -5px rgba(123, 104, 238, 0.1), 0 8px 10px -6px rgba(123, 104, 238, 0.1);
            }
            .hover-scale {
                transition: transform 0.3s ease;
            }
            .hover-scale:hover {
                transform: scale(1.02);
            }
        }
    </style>
    <!-- 自定义CSS -->
    <style>
        body {
            background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .table-wrapper {
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal-backdrop {
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="font-genshin text-white">
    <!-- 登录模态框 -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-md flex items-center justify-center">
        <div class="bg-gradient-abyss rounded-xl p-8 shadow-2xl w-full max-w-md card-shadow">
            <div class="text-center mb-6">
                <i class="fa fa-lock text-4xl text-abyss-primary mb-4"></i>
                <h2 class="text-2xl font-bold text-white">管理员登录</h2>
                <p class="text-abyss-light mt-2">请输入密码以访问管理后台</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="form-group">
                    <label for="admin-password" class="block text-sm font-medium text-abyss-light mb-1">管理员密码</label>
                    <input type="password" id="admin-password" name="password" 
                           class="w-full px-4 py-3 rounded-lg bg-abyss-dark/60 border border-abyss-primary/30 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary transition-all" 
                           placeholder="请输入密码" required>
                </div>
                <div id="login-error" class="text-red-400 text-sm hidden"></div>
                <button type="submit" 
                        class="w-full px-6 py-3 bg-abyss-primary hover:bg-abyss-secondary text-white font-bold rounded-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-abyss-primary focus:ring-offset-2">
                    <i class="fa fa-sign-in mr-2"></i>登录
                </button>
            </form>
        </div>
    </div>

    <!-- 头部 -->
    <header class="bg-abyss-dark/80 backdrop-blur-lg border-b border-abyss-primary/20 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-abyss-primary flex items-center">
                <i class="fa fa-shield text-abyss-primary mr-2"></i>
                幽境危战 - 管理员后台
            </h1>
            <div class="flex items-center space-x-4">
                <div class="bg-abyss-primary/10 px-4 py-2 rounded-full flex items-center">
                    <i class="fa fa-user-circle text-abyss-primary mr-2"></i>
                    <span id="admin-user">管理员</span>
                </div>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all transform hover:scale-105">
                    <i class="fa fa-sign-out mr-2"></i>退出登录
                </button>
                    <i class="fa fa-bell text-abyss-primary mr-2"></i>
                    <span id="pending-count" class="bg-abyss-danger text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                </div>
                <button id="refresh-btn" class="bg-abyss-primary/20 hover:bg-abyss-primary/30 text-abyss-primary px-4 py-2 rounded-lg transition-all flex items-center">
                    <i class="fa fa-refresh mr-2"></i> 刷新数据
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 筛选和搜索区域 -->
        <div class="bg-abyss-dark/60 backdrop-blur-lg rounded-xl p-6 mb-8 card-shadow border border-abyss-primary/10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="status-filter" class="block text-sm font-medium text-abyss-light mb-2">状态筛选</label>
                    <select id="status-filter" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                        <option value="all">全部记录</option>
                        <option value="pending">待审核</option>
                        <option value="approved">已通过</option>
                        <option value="denied">已拒绝</option>
                    </select>
                </div>
                <div>
                    <label for="boss-filter" class="block text-sm font-medium text-abyss-light mb-2">Boss筛选</label>
                    <select id="boss-filter" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                        <option value="all">所有Boss</option>
                        <!-- Boss选项将通过JavaScript动态填充 -->
                    </select>
                </div>
                <div>
                    <label for="search-input" class="block text-sm font-medium text-abyss-light mb-2">搜索记录</label>
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="搜索玩家名称或备注..." class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary pr-10">
                        <i class="fa fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-abyss-light"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 记录表格 -->
        <div class="bg-abyss-dark/60 backdrop-blur-lg rounded-xl p-6 card-shadow border border-abyss-primary/10 mb-8">
            <h2 class="text-xl font-bold text-abyss-primary mb-4">记录管理</h2>
            <div class="table-wrapper">
                <table class="w-full min-w-full">
                    <thead class="bg-abyss-dark/80 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-abyss-light uppercase tracking-wider">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-abyss-light uppercase tracking-wider">玩家</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-abyss-light uppercase tracking-wider">主C</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-abyss-light uppercase tracking-wider">Boss</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-abyss-light uppercase tracking-wider">时间</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-abyss-light uppercase tracking-wider">限定金数</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-abyss-light uppercase tracking-wider">状态</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-abyss-light uppercase tracking-wider">提交时间</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-abyss-light uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="records-table" class="divide-y divide-abyss-primary/10">
                        <!-- 记录将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 修改记录模态框 -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-abyss-dark rounded-xl p-6 max-w-2xl w-full mx-4 card-shadow border border-abyss-primary/20">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-abyss-primary">修改记录</h2>
                <button id="close-modal" class="text-abyss-light hover:text-white text-2xl">&times;</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="edit-player" class="block text-sm font-medium text-abyss-light mb-2">玩家名称</label>
                        <input type="text" id="edit-player" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                    </div>
                    <div>
                        <label for="edit-mainc" class="block text-sm font-medium text-abyss-light mb-2">主C</label>
                        <input type="text" id="edit-mainc" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="edit-boss" class="block text-sm font-medium text-abyss-light mb-2">Boss</label>
                        <input type="text" id="edit-boss" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                    </div>
                    <div>
                        <label for="edit-time" class="block text-sm font-medium text-abyss-light mb-2">时间（秒）</label>
                        <input type="number" id="edit-time" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="edit-gold" class="block text-sm font-medium text-abyss-light mb-2">限定金数</label>
                        <input type="number" id="edit-gold" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                    </div>
                    <div>
                        <label for="edit-constgold" class="block text-sm font-medium text-abyss-light mb-2">常驻金数</label>
                        <input type="number" id="edit-constgold" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="edit-status" class="block text-sm font-medium text-abyss-light mb-2">状态</label>
                    <select id="edit-status" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                        <option value="pending">待审核</option>
                        <option value="approved">已通过</option>
                        <option value="denied">已拒绝</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="edit-notes" class="block text-sm font-medium text-abyss-light mb-2">备注</label>
                    <textarea id="edit-notes" rows="3" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary"></textarea>
                </div>
                <div class="mb-4">
                    <label for="edit-video" class="block text-sm font-medium text-abyss-light mb-2">视频链接</label>
                    <input type="text" id="edit-video" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary">
                </div>
                <div class="mb-4">
                    <label for="edit-team" class="block text-sm font-medium text-abyss-light mb-2">队伍配置（JSON格式：[{"name":"角色名","constellation":命座数},{"name":"角色名","constellation":命座数},...]）</label>
                    <textarea id="edit-team" rows="4" class="w-full bg-abyss-dark/80 border border-abyss-primary/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-abyss-primary"></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-edit" class="bg-abyss-primary/20 hover:bg-abyss-primary/30 text-abyss-primary px-6 py-3 rounded-lg transition-all">取消</button>
                    <button type="submit" class="bg-abyss-primary hover:bg-abyss-secondary text-white px-6 py-3 rounded-lg transition-all">保存修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 脚本 -->
    <script>
        // 全局变量
        let records = [];
        let filteredRecords = [];
        let adminToken = null;

        // DOM加载完成后执行初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            checkLoginStatus();
            
            // 初始化登录事件监听
            initLoginEventListeners();
        });

        // 初始化登录事件监听
        function initLoginEventListeners() {
            // 登录表单提交
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // 退出登录按钮
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        }

        // 检查登录状态
        function checkLoginStatus() {
            // 从localStorage获取token
            adminToken = localStorage.getItem('adminToken');
            if (adminToken) {
                // 已登录，隐藏登录模态框
                hideLoginModal();
                // 初始化管理员功能
                initAdminFeatures();
            } else {
                // 未登录，显示登录模态框
                showLoginModal();
            }
        }

        // 处理登录
        function handleLogin(e) {
            e.preventDefault();
            
            const password = document.getElementById('admin-password').value;
            const errorElement = document.getElementById('login-error');
            
            // 简单的前端验证（实际项目中应该在服务器端验证）
            // 发送请求到API验证密码
            fetch('/api/admin/records?password=' + encodeURIComponent(password))
                .then(response => {
                    if (response.ok) {
                        // 登录成功
                        adminToken = password; // 在实际项目中应该是从服务器获取的JWT
                        localStorage.setItem('adminToken', adminToken);
                        hideLoginModal();
                        initAdminFeatures();
                    } else {
                        // 登录失败
                        errorElement.textContent = '密码错误，请重试';
                        errorElement.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('登录请求失败:', error);
                    errorElement.textContent = '登录失败，请稍后重试';
                    errorElement.classList.remove('hidden');
                });
        }

        // 处理退出登录
        function handleLogout() {
            // 清除localStorage中的token
            localStorage.removeItem('adminToken');
            adminToken = null;
            
            // 显示登录模态框
            showLoginModal();
            
            // 清空记录数据
            records = [];
            filteredRecords = [];
            document.getElementById('records-table').innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-abyss-light">请先登录</td></tr>';
        }

        // 显示登录模态框
        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
        }

        // 隐藏登录模态框
        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-form').reset();
        }

        // 初始化管理员功能
        function initAdminFeatures() {
            // 加载记录数据
            loadRecords();
            // 加载待审核记录数量
            loadPendingCount();
            // 设置事件监听器
            setupEventListeners();
            
            // 定期刷新待审核数量
            setInterval(loadPendingCount, 30000);
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 刷新按钮
            document.getElementById('refresh-btn').addEventListener('click', function() {
                loadRecords();
                loadPendingCount();
            });

            // 筛选器
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('boss-filter').addEventListener('change', applyFilters);
            document.getElementById('search-input').addEventListener('input', applyFilters);

            // 模态框关闭
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('cancel-edit').addEventListener('click', closeModal);

            // 点击模态框背景关闭
            document.getElementById('edit-modal').addEventListener('click', function(e) {
                if (e.target.id === 'edit-modal') {
                    closeModal();
                }
            });

            // 表单提交
            document.getElementById('edit-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateRecord();
            });
        }

        // 加载所有记录
        async function loadRecords() {
            try {
                const response = await fetch('/api/admin/records', {
                    headers: {
                        'Admin-Token': adminToken
                    }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        // 未授权，清除token并显示登录模态框
                        handleLogout();
                        return;
                    }
                    throw new Error('网络响应错误');
                }
                const data = await response.json();
                records = data.records;
                
                // 更新Boss筛选器选项
                updateBossFilter();
                
                // 应用筛选
                applyFilters();
            } catch (error) {
                console.error('加载记录失败:', error);
                showNotification('加载记录失败', 'danger');
            }
        }

        // 加载待审核数量
        async function loadPendingCount() {
            try {
                const response = await fetch('/api/pending-count', {
                    headers: {
                        'Admin-Token': adminToken
                    }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        // 未授权，清除token并显示登录模态框
                        handleLogout();
                        return;
                    }
                    throw new Error('网络响应错误');
                }
                const data = await response.json();
                pendingCount = data.pendingCount;
                document.getElementById('pending-count-badge').textContent = pendingCount;
                document.getElementById('pending-count').textContent = pendingCount;
            } catch (error) {
                console.error('加载待审核数量失败:', error);
                // 不显示错误通知，避免影响用户体验
            }
        }

        // 更新Boss筛选器选项
        function updateBossFilter() {
            const bossFilter = document.getElementById('boss-filter');
            const existingOptions = Array.from(bossFilter.options).slice(1); // 保留第一个选项
            
            // 移除现有选项
            existingOptions.forEach(option => option.remove());
            
            // 添加Boss选项
            DataStore.bosses.forEach(boss => {
                const option = document.createElement('option');
                option.value = boss.name;
                option.textContent = boss.name;
                bossFilter.appendChild(option);
            });
        }

        // 更新主C选择框选项
        function updateMaincSelect() {
            const maincSelect = document.getElementById('edit-mainc');
            const existingOptions = Array.from(maincSelect.options).slice(1); // 保留第一个选项
            
            // 移除现有选项
            existingOptions.forEach(option => option.remove());
            
            // 添加主C选项
            characters.forEach(character => {
                const option = document.createElement('option');
                option.value = character.name;
                option.textContent = character.name;
                maincSelect.appendChild(option);
            });
        }

        // 更新Boss选择框选项
        function updateBossSelect() {
            const bossSelect = document.getElementById('edit-boss');
            const existingOptions = Array.from(bossSelect.options).slice(1); // 保留第一个选项
            
            // 移除现有选项
            existingOptions.forEach(option => option.remove());
            
            // 添加Boss选项
            DataStore.bosses.forEach(boss => {
                const option = document.createElement('option');
                option.value = boss.name;
                option.textContent = boss.name;
                bossSelect.appendChild(option);
            });
        }

        // 应用筛选
        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const bossFilter = document.getElementById('boss-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            filteredRecords = records.filter(record => {
                const matchesStatus = statusFilter === 'all' || record.status === statusFilter;
                const matchesBoss = bossFilter === 'all' || record.boss === bossFilter;
                const matchesSearch = record.player.toLowerCase().includes(searchTerm) || 
                                     record.mainc.toLowerCase().includes(searchTerm) ||
                                     record.notes.toLowerCase().includes(searchTerm);
                
                return matchesStatus && matchesBoss && matchesSearch;
            });

            renderRecords();
        }

        // 渲染记录表格
        function renderRecords() {
            const tableBody = document.getElementById('records-table');
            
            if (filteredRecords.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="px-4 py-8 text-center text-abyss-light">没有找到符合条件的记录</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = filteredRecords.map(record => `
                <tr class="hover:bg-abyss-primary/5 transition-all">
                    <td class="px-4 py-3">${record.id}</td>
                    <td class="px-4 py-3">${record.player}</td>
                    <td class="px-4 py-3">${record.mainc}</td>
                    <td class="px-4 py-3">${record.boss}</td>
                    <td class="px-4 py-3">${formatTime(record.time)}</td>
                    <td class="px-4 py-3">${record.gold}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${getStatusClass(record.status)}">
                            ${getStatusText(record.status)}
                        </span>
                    </td>
                    <td class="px-4 py-3">${formatDate(record.submitTime)}</td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button class="edit-btn bg-abyss-primary/20 hover:bg-abyss-primary/30 text-abyss-primary px-3 py-1 rounded-lg transition-all text-sm" data-id="${record.id}">
                                <i class="fa fa-pencil mr-1"></i> 编辑
                            </button>
                            <button class="delete-btn bg-abyss-danger/20 hover:bg-abyss-danger/30 text-abyss-danger px-3 py-1 rounded-lg transition-all text-sm" data-id="${record.id}">
                                <i class="fa fa-trash mr-1"></i> 删除
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // 绑定编辑和删除按钮事件
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openEditModal(parseInt(this.dataset.id));
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = parseInt(this.dataset.id);
                    if (confirm('确定要删除这条记录吗？此操作不可恢复。')) {
                        deleteRecord(recordId);
                    }
                });
            });
        }

        // 打开修改记录模态框
        function openEditModal(recordId) {
            isCreatingNew = false;
            
            // 根据ID查找记录
            const record = records.find(r => r.id === recordId);
            if (!record) {
                console.error('未找到记录:', recordId);
                showNotification('未找到记录', 'danger');
                return;
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
            document.querySelector('#edit-modal h2').textContent = '修改记录';
            document.querySelector('#edit-form button[type="submit"]').textContent = '保存修改';
            
            // 填充表单数据
            document.getElementById('edit-id').value = record.id;
            document.getElementById('edit-player').value = record.player;
            document.getElementById('edit-mainc').value = record.mainc;
            document.getElementById('edit-boss').value = record.boss;
            document.getElementById('edit-time').value = record.time;
            document.getElementById('edit-gold').value = record.gold;
            document.getElementById('edit-constgold').value = record.constgold || 0;
            document.getElementById('edit-status').value = record.status;
            document.getElementById('edit-notes').value = record.notes || '';
            document.getElementById('edit-video').value = record.video || '';
            document.getElementById('edit-team').value = JSON.stringify(record.team || [], null, 2);
        }

        // 显示队伍配置
        function displayTeam(team) {
            // 这个函数现在不再使用，因为我们改为使用文本输入框显示队伍信息
        }

        // 创建新记录
        function createNewRecord() {
            isCreatingNew = true;
            document.getElementById('edit-modal').classList.remove('hidden');
            document.querySelector('#edit-modal h2').textContent = '新建记录';
            document.querySelector('#edit-form button[type="submit"]').textContent = '创建记录';
            
            // 清空表单
            document.getElementById('edit-id').value = '';
            document.getElementById('edit-player').value = '';
            document.getElementById('edit-mainc').value = '';
            document.getElementById('edit-boss').value = '';
            document.getElementById('edit-time').value = 0;
            document.getElementById('edit-gold').value = 0;
            document.getElementById('edit-constgold').value = 0;
            document.getElementById('edit-status').value = 'approved';
            document.getElementById('edit-notes').value = '';
            document.getElementById('edit-video').value = '';
            
            // 清空队伍配置
            clearTeamSlots();
        }

        // 清空队伍配置
        function clearTeamSlots() {
            document.getElementById('edit-team').value = '';
        }

        // 获取当前队伍配置
        function getCurrentTeam() {
            try {
                const teamText = document.getElementById('edit-team').value;
                return teamText ? JSON.parse(teamText) : [];
            } catch (error) {
                console.error('解析队伍配置失败:', error);
                showNotification('队伍配置格式错误，请检查JSON格式', 'danger');
                return [];
            }
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-form').reset();
        }

        // 更新记录
        async function updateRecord() {
            const id = document.getElementById('edit-id').value;
            let video = document.getElementById('edit-video').value;
            // 如果视频链接没有协议，添加 https://
            if (video && !video.startsWith('http')) {
                video = 'https://' + video;
            }
            const recordData = {
                player: document.getElementById('edit-player').value,
                mainc: document.getElementById('edit-mainc').value,
                team: getCurrentTeam(),
                boss: document.getElementById('edit-boss').value,
                time: parseInt(document.getElementById('edit-time').value),
                gold: parseInt(document.getElementById('edit-gold').value),
                constgold: parseInt(document.getElementById('edit-constgold').value),
                status: document.getElementById('edit-status').value,
                notes: document.getElementById('edit-notes').value,
                video: video
            };

            try {
                const response = await fetch(`/api/admin/records/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Admin-Token': adminToken
                    },
                    body: JSON.stringify(recordData)
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // 未授权，清除token并显示登录模态框
                        handleLogout();
                        return;
                    }
                    throw new Error('更新失败');
                }

                const data = await response.json();
                if (data.success) {
                    showNotification('记录更新成功', 'success');
                    loadRecords();
                    closeModal();
                } else {
                    showNotification('更新失败: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('更新记录失败:', error);
                showNotification('更新记录失败: ' + error.message, 'danger');
            }
        }

        // 创建记录
        async function createRecord() {
            let video = document.getElementById('edit-video').value;
            // 如果视频链接没有协议，添加 https://
            if (video && !video.startsWith('http')) {
                video = 'https://' + video;
            }
            const recordData = {
                player: document.getElementById('edit-player').value,
                mainc: document.getElementById('edit-mainc').value,
                team: getCurrentTeam(),
                boss: document.getElementById('edit-boss').value,
                time: parseInt(document.getElementById('edit-time').value),
                gold: parseInt(document.getElementById('edit-gold').value),
                constgold: parseInt(document.getElementById('edit-constgold').value),
                status: document.getElementById('edit-status').value,
                notes: document.getElementById('edit-notes').value,
                video: video,
                submitTime: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/admin/records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Admin-Token': adminToken
                    },
                    body: JSON.stringify(recordData)
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // 未授权，清除token并显示登录模态框
                        handleLogout();
                        return;
                    }
                    throw new Error('创建失败');
                }

                const data = await response.json();
                if (data.success) {
                    showNotification('记录创建成功', 'success');
                    loadRecords();
                    closeModal();
                } else {
                    showNotification('创建失败: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('创建记录失败:', error);
                showNotification('创建记录失败: ' + error.message, 'danger');
            }
        }

        // 删除记录
        async function deleteRecord(id) {

            try {
                const response = await fetch(`/api/admin/records/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Admin-Token': adminToken
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // 未授权，清除token并显示登录模态框
                        handleLogout();
                        return;
                    }
                    throw new Error('删除失败');
                }

                const data = await response.json();
                if (data.success) {
                    showNotification('记录删除成功', 'success');
                    loadRecords();
                    loadPendingCount();
                } else {
                    showNotification('删除失败: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('删除记录失败:', error);
                showNotification('删除记录失败: ' + error.message, 'danger');
            }
        }

        // 辅助函数：格式化时间
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 辅助函数：格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 辅助函数：获取状态类
        function getStatusClass(status) {
            switch (status) {
                case 'pending':
                    return 'bg-abyss-warning/20 text-abyss-warning';
                case 'approved':
                    return 'bg-abyss-success/20 text-abyss-success';
                case 'denied':
                    return 'bg-abyss-danger/20 text-abyss-danger';
                default:
                    return 'bg-abyss-light/20 text-abyss-light';
            }
        }

        // 辅助函数：获取状态文本
        function getStatusText(status) {
            switch (status) {
                case 'pending':
                    return '待审核';
                case 'approved':
                    return '已通过';
                case 'denied':
                    return '已拒绝';
                default:
                    return status;
            }
        }

        // 辅助函数：显示通知
        function showNotification(message, type) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transition-all transform translate-x-full`;
            
            // 设置样式
            if (type === 'success') {
                notification.classList.add('bg-abyss-success/90', 'text-white');
            } else if (type === 'danger') {
                notification.classList.add('bg-abyss-danger/90', 'text-white');
            } else {
                notification.classList.add('bg-abyss-primary/90', 'text-white');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 动画效果
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 10);
            
            // 自动关闭
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>